<!--
Copyright SecureKey Technologies Inc. All Rights Reserved.

SPDX-License-Identifier: Apache-2.0
 -->

<!doctype html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css">
    <script src="https://unpkg.com/credential-handler-polyfill@2.1.1/dist/credential-handler-polyfill.min.js"></script>
    <script src="https://unpkg.com/web-credential-handler@1.0.1/dist/web-credential-handler.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
            integrity="sha512-CNgIRecGo7nphbeZ04Sc13ka07paqdeTu0WR1IM4kNcpmBAUSHSQX0FslNhTDadL4O5SAGapGt4FodqL8My0mA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <meta charset="UTF-8">
    <title>Bank Account [Pre Auth]</title>
</head>
<body>
<div class="flex flex-wrap py-2 shadow-lg bg-white">
    <div class="w-full p-4">
        <div class="grid place-items-center">
            <label>[test-org] wants to issue [PermanentResidentCard]</label>
        </div>
    </div>
    <div class="w-full p-4">
        <div class="grid place-items-center">
            <div id="qrCode"></div>
        </div>
    </div>
    <div class="w-full p-4">
        <label>{{.URL}}</label>
    </div>
    <div class="w-full p-4">
        <div class="grid place-items-center">
            <button id="scanButton"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">SCAN
            </button>
        </div>
    </div>
    <div class="w-full p-4">
        <label id="accessToken"></label>
    </div>
    <div class="w-full p-4" id="requestCredentials" style="display: none">
        <div class="grid place-items-center">
            <button id="requestCredentialsButton"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">Request Credentials
            </button>
        </div>
    </div>
    <div class="w-full p-4" id="credentialsBlock" style="display: none">
        <label id="credentials"></label>
    </div>
</div>
</body>
<script>
    window.rawURL = {{.URL}}
    parsedUrl = new URL(window.rawURL)

    new QRCode(document.getElementById("qrCode"),window.rawURL);
    $("#scanButton").on('click', function() {
        let bodyFormData = new URLSearchParams();
        bodyFormData.append('grant_type', 'urn:ietf:params:oauth:grant-type:pre-authorized_code');
        bodyFormData.append('pre-authorized_code', parsedUrl.searchParams.get("pre-authorized_code"));

        window.axios({
            method: "post",
            url: parsedUrl.searchParams.get("issuer"),
            data: bodyFormData,
        })
            .then(function (response) {
                //handle success
                window.accessToken = response.data.access_token;
                $("#accessToken").text(`Got token : ${response.data.access_token}`);
                $("#requestCredentials").show();
            })
            .catch(function (response) {
                //handle error
                console.log(response);
            });
    });
    $("#requestCredentialsButton").on('click', function() {
        window.axios({
            method: "post",
            url: "https://vcs.local.trustbloc.dev/oidc/credential",
            data: {
                did: "some-did",
                format: "ldp_vc",
                type: "PermanentResidentCard",
            },
            headers: {
                authorization: `Bearer ${window.accessToken}`,
            }
        })
            .then(function (response) {
                //handle success
                console.log(response);
                $("#accessToken").text(`Got token : ${response.data.access_token}`);
                $("#requestCredentials").show();
            })
            .catch(function (response) {
                //handle error
                console.log(response);
            });
    })

    // // Construct the WebCredential wrapper around the credential to be stored
    // const webCredentialWrapper = new WebCredential('VerifiablePresentation', vp);
    // // Use Credential Handler API to store
    // result = await navigator.credentials.store(webCredentialWrapper);
    // window.rawURL = {{.URL}}

    // alert(window.rawURL)
</script>
</html>