<!--
Copyright SecureKey Technologies Inc. All Rights Reserved.

SPDX-License-Identifier: Apache-2.0
 -->

<!doctype html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css">
    <script src="https://unpkg.com/credential-handler-polyfill@2.1.1/dist/credential-handler-polyfill.min.js"></script>
    <script src="https://unpkg.com/web-credential-handler@1.0.1/dist/web-credential-handler.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
            integrity="sha512-CNgIRecGo7nphbeZ04Sc13ka07paqdeTu0WR1IM4kNcpmBAUSHSQX0FslNhTDadL4O5SAGapGt4FodqL8My0mA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <meta charset="UTF-8">
    <title>Permanent Resident Card [Pre Auth]</title>
</head>
<body>
<div class="flex flex-wrap py-2 shadow-lg bg-white">
    <div class="w-full p-4">
        <div class="grid place-items-center debug">
            <label>[test-org] wants to issue [PermanentResidentCard]</label>
        </div>
    </div>
    <div class="w-full p-4">
        <div class="grid place-items-center">
            <label id="txState">State: awaiting QR code scan</label>
        </div>
    </div>
    <div class="w-full p-4">
        <div class="grid place-items-center">
            <div id="qrCode"></div>
        </div>
    </div>
    <div class="w-full p-4">
        <div class="grid place-items-center">
            <div>
                <label for="pin" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">PIN</label>
                <input type="text" id="pin"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                       placeholder="123" readonly>
            </div>
        </div>
    </div>
    <div class="w-full p-4 debug">
        <label>{{.URL}}</label>
    </div>
    <div class="w-full p-4 debug">
        <div class="grid place-items-center">
            <button id="scanButton"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">SCAN
            </button>
        </div>
    </div>
    <div class="w-full p-4 debug">
        <label id="accessToken"></label>
    </div>
    <div class="w-full p-4 debug">
        <label id="cNonce"></label>
    </div>
    <div class="w-full p-4 debug">
        <label id="wellKnown"></label>
    </div>
    <div class="w-full p-4 debug" id="requestCredentials" style="display: none">
        <div class="grid place-items-center">
            <button id="requestCredentialsButton"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full">Request
                Credentials
            </button>
        </div>
    </div>
    <div class="w-full p-4 debug">
        <label id="proof"></label>
    </div>
    <div class="w-full p-4 debug" id="credentialsBlock" style="display: none">
        <label id="credentials"></label>
    </div>
    <div class="w-full p-4">
        <div class="grid place-items-center" id="successBlock" style="display: none">
            <label>{{.SuccessText}}</label>
        </div>
    </div>
</div>
</body>
<script>
    $(".debug").hide()

    window.rawURL = {{.URL}}
    window.txId = {{.TxID}}

    parsedUrl = new URL(window.rawURL)
    new QRCode(document.getElementById("qrCode"), window.rawURL);
    $("#scanButton").on('click', function () {
        window.axios({
            method: "get",
            url: `${parsedUrl.searchParams.get("issuer")}/.well-known/openid-configuration`
        }).then(function (wellKnown) {
            $("#wellKnown").text(`well-known token endpoint: ${wellKnown.data.token_endpoint}`)
            let bodyFormData = new URLSearchParams();
            bodyFormData.append('grant_type', 'urn:ietf:params:oauth:grant-type:pre-authorized_code');
            bodyFormData.append('pre-authorized_code', parsedUrl.searchParams.get("pre-authorized_code"));
            bodyFormData.append('user_pin', "123");

            window.wellKnown = wellKnown.data

            window.axios({
                method: "post",
                url: wellKnown.data.token_endpoint,
                data: bodyFormData,
            })
                .then(function (response) {
                    //handle success
                    console.log(response)
                    window.accessToken = response.data.access_token;
                    window.cNonce = response.data.c_nonce;
                    $("#accessToken").text(`Got token : ${response.data.access_token}`);
                    $("#cNonce").text(`Got c_nonce : ${response.data.c_nonce}`);
                    $("#requestCredentials").show();
                })
                .catch(function (response) {
                    //handle error
                    console.log(response);
                });
        });
    })

    window.setState = function () {
        window.axios({
            method: "get",
            url: "/verify/openid4ci/webhook/check?tx="+window.txId,
        }).then(function (stateResp) {
            if (!stateResp.data.type){
                return
            }

            console.log(stateResp)
            let text = "State: "
            switch (stateResp.data.type) {
                case "oidc_interaction_initiated":
                    text += "awaiting QR code scan"
                    break
                case "oidc_interaction_succeeded":
                    text += "issued successfully"
                    $("#qrCode").hide()
                    $("#successBlock").show()
                    break
                case "oidc_interaction_qr_scanned":
                    text += "QR code scanned"
                    break
            }
            $("#txState").text(text)
        });
    }
    window.setState()
    setInterval(window.setState, 1000)

    $("#requestCredentialsButton").on('click', function () {
        let bodyFormData = new URLSearchParams();
        bodyFormData.append('cNonce', window.cNonce);
        bodyFormData.append('pre-authorized_code', parsedUrl.searchParams.get("pre-authorized_code"));

        window.axios({
            method: "post",
            url: "/credential-proof",
            data: bodyFormData,
        }).then(function (proofResp) {
            $("#proof").text(`Credentials request : ` + JSON.stringify(proofResp.data))
            console.log(proofResp)
            window.axios({
                method: "post",
                url: window.wellKnown.credential_endpoint,
                data: {
                    did: proofResp.data.did,
                    format: proofResp.data.format,
                    proof: proofResp.data.proof,
                    type: "PermanentResidentCard",
                },
                headers: {
                    authorization: `Bearer ${window.accessToken}`,
                }
            })
                .then(function (response) {
                    //handle success
                    console.log(response);
                    $("#credentialsBlock").show();
                    $("#credentials").text(JSON.stringify(response.data))
                })
                .catch(function (response) {
                    //handle error
                    console.log(response);
                });
        })
    })

    // // Construct the WebCredential wrapper around the credential to be stored
    // const webCredentialWrapper = new WebCredential('VerifiablePresentation', vp);
    // // Use Credential Handler API to store
    // result = await navigator.credentials.store(webCredentialWrapper);
    // window.rawURL = {{.URL}}

    // alert(window.rawURL)
</script>
</html>